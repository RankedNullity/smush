# Smush

A standalone Bun-powered tool to consolidate multiple Prisma migrations into a single migration whiâ”œâ”€â”€ ğŸ“ steps/
â”‚   â”œâ”€â”€ ğŸ“„ step1-backup.ts     # Backup migrations & extract/filter queries
â”‚   â”œâ”€â”€ ğŸ“„ step2-reset.ts      # Reset DB & generate consolidated migration
â”‚   â”œâ”€â”€ ğŸ“„ step3-parse.ts      # Parse new migration & update query table
â”‚   â”œâ”€â”€ ğŸ“„ step4-filter.ts     # Apply remaining pattern filters (legacy)
â”‚   â””â”€â”€ ğŸ“„ step5-save.ts       # Save remaining queries to file

Smush is a powerful tool for consolidating Prisma migrations, automatically detecting and removing redundant operations while preserving important changes.

## ğŸš€ Features

- **ğŸ”§ Standalone tool** - No global installation required, works with any Prisma project
- **ğŸ“ Flexible directory support** - Use `--prisma-dir=/path/to/prisma` to target any Prisma project
- **ğŸ§  Smart dynamic filtering** - Automatically detects and removes redundant CREATE/DROP pairs
- **âš™ï¸ Configurable pattern filters** - Customizable regex patterns to exclude specific query types
- **ğŸ“Š Detailed tracking** - Saves filtered queries with explanations for manual review
- **ğŸ§¹ Clean operation** - Automatic backup and cleanup with no side effects
- **âš¡ Database reset approach** - Generates truly consolidated migrations from your current schema

## ğŸ“¦ Installation

### Quick Start (Recommended)
```bash
# Clone and setup
git clone https://github.com/RankedNullity/smush.git
cd smush
bun install

# Verify installation
bun run help
```

### Alternative: Download Release
```bash
# Download latest release
curl -L -o smush.zip https://github.com/RankedNullity/smush/archive/main.zip
unzip smush.zip && cd smush-main
bun install
```

## ğŸ¯ Quick Start

### Basic Usage
You must have a prisma provider running somewhere. The instance should be empty (DONT USE ACTUAL DATA!!) so we can generate the fresh migration. 

```bash
# Run all steps on your Prisma project
bun smush.ts --prisma-dir=/path/to/your/prisma

# Show detailed help
bun smush.ts --help
```

### Step-by-Step Execution
```bash
# Run specific steps
bun smush.ts 1-3 --prisma-dir=/path/to/your/prisma        # Steps 1 through 3
bun smush.ts 1,4,5 --prisma-dir=/path/to/your/prisma      # Steps 1, 4, and 5 only
bun smush.ts 2 --prisma-dir=/path/to/your/prisma          # Step 2 only

# Individual step scripts (advanced usage)
bun run step1 --prisma-dir=/path/to/your/prisma    # Backup migrations and extract/filter queries  
bun run step2 --prisma-dir=/path/to/your/prisma    # Reset database and generate consolidated migration
bun run step3 --prisma-dir=/path/to/your/prisma    # Parse new migration and clean query table
bun run step4 --prisma-dir=/path/to/your/prisma    # Apply remaining pattern filters (legacy step)
bun run step5 --prisma-dir=/path/to/your/prisma    # Save remaining queries to file
```

## âš™ï¸ Configuration

### Customizing Query Filters

Smush uses a **two-stage filtering system** to intelligently remove redundant SQL queries:

#### Stage 1: Dynamic CREATE/DROP Analysis
Automatically detects and removes redundant CREATE/DROP pairs by analyzing the migration chronologically:
- **Objects**: Tables, indexes, views, functions, etc.
- **Constraints**: Primary keys, foreign keys, unique constraints, check constraints, etc.

If a `CREATE X` statement is followed by a `DROP X` for the same object/constraint, both are removed as redundant.

#### Stage 2: Pattern-Based Filtering 
Uses configurable regex patterns from `filters.json`:

```json
{
  "filters": [
    {
      "name": "DROP operations",
      "patterns": ["^DROP\\s", "DROP\\s+INDEX", "DROP\\s+TABLE"],
      "reason": "DROP operations are typically destructive and need manual review",
      "enabled": true
    },
    {
      "name": "CREATE TABLE operations", 
      "patterns": ["^CREATE\\s+TABLE"],
      "reason": "CREATE TABLE operations should be generated by schema changes",
      "enabled": true
    }
  ]
}
```

**Filter Properties:**
- `name` - Human-readable description of the filter
- `patterns` - Array of regex patterns to match SQL queries
- `reason` - Explanation for why matching queries are filtered out
- `enabled` - Whether this filter is currently active

> **ğŸ’¡ Pro Tip**: Dynamic filtering runs first to preserve DROP statements needed for analysis, then pattern filtering applies to the remaining queries.

## ğŸ“ Project Structure

```
smush/
â”œâ”€â”€ ğŸ“„ smush.ts            # Main executable script  
â”œâ”€â”€ ï¿½ steps/
â”‚   â”œâ”€â”€ ï¿½ğŸ“„ step1-backup.ts     # Backup migrations & extract queries
â”‚   â”œâ”€â”€ ğŸ“„ step2-reset.ts      # Reset DB & generate consolidated migration
â”‚   â”œâ”€â”€ ğŸ“„ step3-parse.ts      # Parse new migration & update query table
â”‚   â”œâ”€â”€ ğŸ“„ step4-filter.ts     # Apply query filters & save reasons
â”‚   â””â”€â”€ ğŸ“„ step5-save.ts       # Save remaining queries to file
â”œâ”€â”€ âš™ï¸ filters.json        # Query filtering configuration
â”œâ”€â”€ ğŸ“„ package.json        # Project metadata & scripts
â”œâ”€â”€ ğŸ“„ tsconfig.json       # TypeScript configuration
â””â”€â”€ ğŸ“„ bun.lock           # Dependency lock file
```

## ğŸ“¤ Output Files

After running the tool, you'll find:

**In your Prisma project:**
- `prisma/migrations-backup/` - Your original migrations (safely preserved)
- `prisma/migrations/[timestamp]_consolidated/migration.sql` - New consolidated migration
- `prisma/migrations/[timestamp]_consolidated/missing-queries.sql` - Queries not included
- `prisma/migrations/[timestamp]_consolidated/filtered-queries.json` - Filtered queries with reasons

## ğŸ”§ Prerequisites

- **[Bun](https://bun.sh/)** - Fast JavaScript runtime and package manager
- **Prisma project** - Existing project with `prisma/schema.prisma` and migrations
- **Database access** - Active database connection for reset operations

## âš ï¸ Important Safety Notes

> **ğŸš¨ DATABASE RESET WARNING**  
> Step 2 performs `prisma migrate reset --force` which **completely resets your database**!
> Make sure the prisma instance you are on is EMPTY for this tool to work properly. 
**DO NOT USE THIS ON PRODUCTION. USE THIS LOCALLY TO GENERATE THE FILES, THEN APPLY THEM TO PRODUCTION AS NEEDED**

**Safety Checklist:**
- âœ… Only use in **development environments**
- âœ… Ensure you have **database backups**
- âœ… Verify your `schema.prisma` reflects your desired final state
- âœ… Check that database connection is working
- âœ… Original migrations are backed up to `migrations-backup/`

## ğŸ“‹ Step-by-Step Process

| Step | Description | What It Does |
|------|-------------|--------------|
| **1** | Backup & Extract | Moves migrations to backup, extracts SQL queries |
| **2** | Reset & Generate | Resets database, generates new consolidated migration |
| **3** | Parse & Clean | Analyzes new migration, removes duplicate queries |
| **4** | Filter & Sort | Applies filters, saves excluded queries with reasons |
| **5** | Save Results | Creates final missing-queries.sql file |

## ğŸ¤ Contributing

See [CONTRIBUTING.md](CONTRIBUTING.md) for development setup, coding standards, and contribution guidelines.

## ğŸ“„ License

MIT License - see [LICENSE](LICENSE) for details.

## ğŸ› Issues & Support

- **Bug reports**: [GitHub Issues](https://github.com/RankedNullity/smush/issues)
- **Feature requests**: [GitHub Discussions](https://github.com/RankedNullity/smush/discussions)
- **Questions**: Check existing issues or open a new one

---

**Made with âš¡ Bun and â¤ï¸ for the Prisma community**


